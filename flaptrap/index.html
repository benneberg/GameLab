<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Gravity Shift</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#0a0a0a;touch-action:none}
canvas{display:block}
.neo{border:4px solid #000;box-shadow:8px 8px 0 #000}
.flash{position:absolute;inset:0;background:white;opacity:0;pointer-events:none;transition:.15s}
</style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-cyan-900">

<div class="relative w-full h-screen">
<canvas id="c"></canvas>
<div id="flash" class="flash"></div>

<!-- HUD -->
<div class="absolute top-4 left-4 right-4 flex justify-between pointer-events-none">
  <div class="neo bg-black bg-opacity-40 px-4 py-2">
    <div class="text-yellow-300 text-sm">SCORE</div>
    <div id="score" class="text-white text-3xl">0</div>
  </div>
  <div id="gravityArrow" class="neo bg-black bg-opacity-40 px-4 py-2 text-white text-2xl">↑</div>
</div>

<!-- MODE SELECT -->
<div id="start" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-80 z-30">
  <button id="dailyBtn" class="neo bg-pink-500 px-8 py-4 text-2xl mb-4">DAILY RUN</button>
  <button id="randomBtn" class="neo bg-cyan-500 px-8 py-4 text-2xl">RANDOM RUN</button>
</div>

<!-- GAME OVER -->
<div id="over" class="absolute inset-0 hidden flex-col items-center justify-center bg-black bg-opacity-80 z-30">
  <div class="text-red-500 text-4xl mb-4">GAME OVER</div>
  <div id="final" class="text-white text-3xl mb-6"></div>
  <button id="againBtn" class="neo bg-green-500 px-6 py-3 text-xl mb-3">PLAY AGAIN</button>
  <button id="switchBtn" class="neo bg-gray-300 px-6 py-2 text-lg">SWITCH MODE</button>
</div>

<!-- BADGE -->
<div id="badge" class="absolute bottom-4 left-1/2 -translate-x-1/2 hidden z-40">
  <div class="neo bg-fuchsia-500 text-white px-6 py-4 text-center font-black">
    NEW HIGH SCORE<br>
    <span id="badgeScore"></span><br><br>
    <button id="shareBtn" class="neo bg-black px-3 py-1 mr-2">SHARE</button>
    <button id="downloadBtn" class="neo bg-black px-3 py-1">DOWNLOAD</button>
  </div>
</div>
</div>

<script>
/* ================= RNG ================= */
function RNG(seed){let s=seed%2147483647;return()=>((s=s*16807%2147483647)/2147483647)}
let rand;

/* ================= CANVAS ================= */
const c=document.getElementById('c'),ctx=c.getContext('2d');
function resize(){c.width=innerWidth;c.height=innerHeight}
resize();addEventListener('resize',resize);

/* ================= AUDIO ================= */
let audioCtx,osc,filter;
function startAudio(){
  audioCtx=new AudioContext();
  osc=audioCtx.createOscillator();
  filter=audioCtx.createBiquadFilter();
  osc.type='sawtooth';
  osc.frequency.value=120;
  filter.frequency.value=600;
  osc.connect(filter).connect(audioCtx.destination);
  osc.start();
}
function updateAudio(){if(!osc)return;osc.frequency.value=gravity===1?120:180;filter.frequency.value=gravity===1?600:1200}
function stopAudio(){if(osc){osc.stop();osc=null}if(audioCtx){audioCtx.close();audioCtx=null}}

/* ================= STATE ================= */
let running=false;
let currentMode='random';
let score=0,high=0;
let gravity=1;
let nextGravity=0;
let beat=0;
let beatTimer=0;
const BEAT_INTERVAL=60; // frames
const scrollSpeedBase = 3;

/* ================= PLAYER ================= */
const p={x:0,y:0,vx:0,vy:0,r:15};

/* ================= OBSTACLES ================= */
let obs=[];

/* -------- Beat-specific weights -------- */
const BEAT_WEIGHTS=[
  {saw:3,orbit:1,triangle:0,square:1,pendulum:0},
  {saw:2,orbit:2,triangle:1,square:1,pendulum:0},
  {saw:1,orbit:2,triangle:2,square:1,pendulum:1},
  {saw:1,orbit:1,triangle:2,square:2,pendulum:2}
];

/* -------- Pattern factories -------- */
function createSaw(y){return [...Array(3)].map((_,i)=>({type:'saw',x:c.width*0.3+i*120,baseX:c.width*0.3+i*120,y,size:26,rot:0,phase:i*Math.PI/3}))}
function createOrbit(y){const cx=c.width/2; return [...Array(6)].map((_,i)=>({type:'orbit',cx,cy:y,angle:i*Math.PI/3,radius:80,speed:0.03,size:18}))}
function createTriangleWall(y){const side=rand()<0.5?60:c.width-60; return [...Array(4)].map((_,i)=>({type:'triangle',x:side,y:y+i*40,size:22,rot:0}))}
function createSquareGap(y){const gap=Math.floor(rand()*5); return [...Array(5)].flatMap((_,i)=>i===gap?[]:[{type:'square',x:(i+1)*c.width/6,y,size:26,rot:Math.PI/4}])}
function createPendulum(y){return [...Array(3)].map((_,i)=>({type:'pendulum',ax:(i+1)*c.width/4,ay:y-60,angle:Math.PI/2,vel:0,len:70,size:20}))}

const PATTERNS={saw:createSaw,orbit:createOrbit,triangle:createTriangleWall,square:createSquareGap,pendulum:createPendulum};

/* -------- Weighted selection -------- */
function weightedPattern(){
  const w = BEAT_WEIGHTS[beat%BEAT_WEIGHTS.length];
  const bag = [];
  for(const k in w) for(let i=0;i<w[k];i++) bag.push(k);
  if(bag.length===0) return 'saw';
  return bag[Math.floor(rand()*bag.length)];
}

function spawnPattern(){
  const key=weightedPattern();
  const offset=-80+rand()*40;
  obs.push(...PATTERNS[key](offset));
}

/* ================= INPUT ================= */
function input(e){
  if(!running)return;
  const x=e.touches?e.touches[0].clientX:e.clientX;
  p.vy=-8*gravity;
  p.vx=x<c.width/2?-5:5;
}
c.addEventListener('mousedown',input);
c.addEventListener('touchstart',input);

/* ================= START / UI ================= */
const start=document.getElementById('start');
const over=document.getElementById('over');
const scoreEl=document.getElementById('score');
const final=document.getElementById('final');
const dailyBtn=document.getElementById('dailyBtn');
const randomBtn=document.getElementById('randomBtn');
const againBtn=document.getElementById('againBtn');
const switchBtn=document.getElementById('switchBtn');
const flash=document.getElementById('flash');
const badge=document.getElementById('badge');
const badgeScore=document.getElementById('badgeScore');
const shareBtn=document.getElementById('shareBtn');
const downloadBtn=document.getElementById('downloadBtn');

dailyBtn.onclick=()=>startGame('daily');
randomBtn.onclick=()=>startGame('random');
againBtn.onclick=()=>startGame(currentMode);
switchBtn.onclick=()=>{
  over.classList.add('hidden');
  start.classList.remove('hidden');
};

function startGame(mode){
  currentMode=mode;
  rand=RNG(mode==='daily'?Number(new Date().toISOString().slice(0,10).replace(/-/g,'')):Date.now());
  high=Number(localStorage.getItem('high_'+mode)||0);
  score=0;gravity=1;beat=0;beatTimer=0;
  nextGravity=300+rand()*300;
  obs=[];
  p.x=c.width/2;p.y=c.height*0.7;p.vx=p.vy=0;
  start.classList.add('hidden'); over.classList.add('hidden'); badge.classList.add('hidden');
  startAudio();
  running=true;
  // spawn initial obstacles immediately
  for(let i=0;i<3;i++) spawnPattern();
  loop();
}

/* ================= LOOP ================= */
function loop(){if(!running)return; update(); draw(); requestAnimationFrame(loop);}

/* ================= UPDATE ================= */
function update(){
  score++;
  scoreEl.textContent=score;
  beatTimer++;
  if(beatTimer>BEAT_INTERVAL){beat++; beatTimer=0; spawnPattern();}
  p.vy+=0.5*gravity;
  p.y+=p.vy;
  p.x+=p.vx;
  p.vx*=0.85;
  p.x=Math.max(p.r,Math.min(c.width-p.r,p.x));
  if(p.y<0||p.y>c.height) return endGame();
  if(score>nextGravity){
    gravity*=-1;
    nextGravity+=400+rand()*400;
    document.getElementById('gravityArrow').textContent=gravity===1?'↑':'↓';
    updateAudio();
    flash.style.opacity=1;
    setTimeout(()=>flash.style.opacity=0,120);
  }
  for(let i=obs.length-1;i>=0;i--){
    const o=obs[i];
    o.y+=scrollSpeedBase;
    if(o.type==='saw'){o.rot+=0.12; o.x=o.baseX+Math.sin(score*0.05+o.phase)*80;}
    if(o.type==='orbit'){o.angle+=o.speed; o.x=o.cx+Math.cos(o.angle)*o.radius; o.y=o.cy+Math.sin(o.angle)*o.radius;}
    if(o.type==='triangle') o.rot+=0.1;
    if(o.type==='square') o.rot+=0.05;
    if(o.type==='pendulum'){o.vel+=-0.01*Math.sin(o.angle); o.angle+=o.vel; o.vel*=0.99; o.x=o.ax+Math.sin(o.angle)*o.len; o.y=o.ay+Math.cos(o.angle)*o.len;}
    const dx=p.x-o.x,dy=p.y-o.y;
    if(Math.hypot(dx,dy)<p.r+(o.size||20)) return endGame();
    if(o.y>c.height+150) obs.splice(i,1);
  }
}

/* ================= DRAW ================= */
function draw(){
  ctx.fillStyle='#080012';
  ctx.fillRect(0,0,c.width,c.height);
  obs.forEach(o=>{
    ctx.save(); ctx.translate(o.x,o.y); ctx.rotate(o.rot||0); ctx.fillStyle='#00ffff';
    if(o.type==='triangle'){ctx.beginPath(); ctx.moveTo(0,-o.size); ctx.lineTo(-o.size,o.size); ctx.lineTo(o.size,o.size); ctx.fill();}
    else if(o.type==='square'){ctx.fillRect(-o.size/2,-o.size/2,o.size,o.size);}
    else{ctx.beginPath(); ctx.arc(0,0,o.size||20,0,Math.PI*2); ctx.fill();}
    ctx.restore();
  });
  ctx.fillStyle='#ff00ff'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
}

/* ================= END ================= */
function endGame(){
  running=false;
  stopAudio();
  final.textContent=score;
  over.classList.remove('hidden');
  if(score>high){
    localStorage.setItem('high_'+currentMode,score);
    badgeScore.textContent=score; badge.classList.remove('hidden');
  }
}

/* ================= SHARE / DOWNLOAD ================= */
shareBtn.onclick=()=>{
  const t=`I scored ${score} in Gravity Shift (${currentMode})`;
  navigator.share?navigator.share({text:t}):navigator.clipboard.writeText(t);
};
downloadBtn.onclick=()=>{
  const b=document.createElement('canvas'); b.width=400; b.height=200;
  const g=b.getContext('2d');
  g.fillStyle='#ff00ff'; g.fillRect(0,0,400,200);
  g.fillStyle='white'; g.font='bold 28px sans-serif';
  g.fillText('HIGH SCORE',90,90);
  g.fillText(score,170,130);
  const a=document.createElement('a'); a.href=b.toDataURL(); a.download='gravity-shift.png'; a.click();
};
</script>
</body>
</html>
